version: 1
features:
  #  Trend Indicators
  sma:
    description: Simple Moving Average
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, volume, vwap],
        }
      window: { type: int, required: true }
  ema:
    description: Exponential Moving Average
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, volume, vwap],
        }
      window: { type: int, required: true }
  macd:
    description: Moving Average Convergence Divergence. Multi-output.
    params:
      "on":
        {
          type: string,
          required: true,
          default: "close",
          allowed: [open, high, low, close, vwap],
        }
      fast_period: { type: int, required: false, default: 12 }
      slow_period: { type: int, required: false, default: 26 }
      signal_period: { type: int, required: false, default: 9 }

  #  Momentum Indicators
  rsi:
    description: Relative Strength Index
    params:
      "on": { type: string, required: true, default: "close", allowed: [close] }
      window: { type: int, required: false, default: 14 }
  stoch:
    description: Stochastic Oscillator. Multi-output (%K, %D).
    params:
      high: { type: string, required: true, default: "high" }
      low: { type: string, required: true, default: "low" }
      close: { type: string, required: true, default: "close" }
      k_window: { type: int, required: false, default: 14 }
      d_window: { type: int, required: false, default: 3 }

  #  Volatility Indicators
  rolling_vol:
    description: Rolling Volatility (Standard Deviation)
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, vwap, ret],
        }
      window: { type: int, required: true }
  atr:
    description: Average True Range
    params:
      high: { type: string, required: true, default: "high" }
      low: { type: string, required: true, default: "low" }
      close: { type: string, required: true, default: "close" }
      window: { type: int, required: false, default: 14 }
  bbands:
    description: Bollinger Bands. Multi-output (upper, middle, lower).
    params:
      "on":
        {
          type: string,
          required: true,
          default: "close",
          allowed: [open, high, low, close, vwap],
        }
      window: { type: int, required: false, default: 20 }
      std_dev: { type: int, required: false, default: 2 }

  # Volume Indicators
  obv:
    description: On-Balance Volume
    params:
      close: { type: string, required: true, default: "close" }
      volume: { type: string, required: true, default: "volume" }

  #  Basic Transformations & Statistics
  ret:
    description: Returns (Log or Simple)
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, vwap],
        }
      periods: { type: int, required: false, default: 1 }
      method:
        {
          type: string,
          required: false,
          default: "log",
          allowed: [log, simple],
        }
  lag:
    description: Lag a column by N periods
    params:
      "on": { type: string, required: true }
      periods: { type: int, required: true }
  diff:
    description: Difference a column by N periods
    params:
      "on": { type: string, required: true }
      periods: { type: int, required: false, default: 1 }
  rolling_max:
    description: Rolling Maximum
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, vwap],
        }
      window: { type: int, required: true }
  rolling_min:
    description: Rolling Minimum
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, vwap],
        }
      window: { type: int, required: true }
  zscore:
    description: Rolling Z-Score
    params:
      "on":
        {
          type: string,
          required: true,
          allowed: [open, high, low, close, vwap, volume],
        }
      window: { type: int, required: true }

  #  Calendar Features
  session_flags:
    description: Creates multiple calendar/time-based features from the index.
    params: {}

  # Generic Helper Functions (Work on Any Column)
  yoy_growth:
    description: Year-over-year percentage change (default periods=4 for quarterly data)
    params:
      "on": { type: string, required: true }
      periods: { type: int, required: false, default: 4 }
  qoq_growth:
    description: Quarter-over-quarter percentage change
    params:
      "on": { type: string, required: true }
  rolling_avg:
    description: Rolling average over N periods
    params:
      "on": { type: string, required: true }
      window: { type: int, required: true }
  pct_change:
    description: Percentage change over N periods
    params:
      "on": { type: string, required: true }
      periods: { type: int, required: true }

  # Balance Sheet Enrichments
  current_ratio:
    description: Current Ratio = Current Assets / Current Liabilities (liquidity measure)
    params: {}
  quick_ratio:
    description: Quick Ratio = (Current Assets - Inventory) / Current Liabilities (acid test)
    params: {}
  debt_to_equity:
    description: Debt-to-Equity Ratio = Total Debt / Total Shareholder Equity (leverage measure)
    params: {}
  debt_to_assets:
    description: Debt-to-Assets Ratio = Total Debt / Total Assets (leverage measure)
    params: {}
  working_capital:
    description: Working Capital = Current Assets - Current Liabilities (liquidity measure)
    params: {}
  equity_ratio:
    description: Equity Ratio = Total Shareholder Equity / Total Assets (solvency measure)
    params: {}

  # Cash Flow Enrichments
  free_cash_flow:
    description: Free Cash Flow = Operating Cash Flow - Capital Expenditures
    params: {}
  operating_cash_margin:
    description: Operating Cash Margin = Operating Cash Flow / Net Income (cash efficiency)
    params: {}
  capex_intensity:
    description: CapEx Intensity = Capital Expenditures / Operating Cash Flow (investment ratio)
    params: {}
  dividend_payout_ratio:
    description: Dividend Payout Ratio = Dividends / Operating Cash Flow (shareholder returns)
    params: {}
  cash_conversion_ratio:
    description: Cash Conversion Ratio = Operating Cash Flow / Net Income (earnings quality)
    params: {}

  # Earnings Enrichments
  earnings_beat:
    description: Earnings Beat = 1 if reported EPS > estimated EPS, else 0 (binary flag)
    params: {}
  avg_surprise:
    description: Rolling average of earnings surprise percentage
    params:
      window: { type: int, required: true }
  earnings_momentum:
    description: Rolling mean of earnings surprise values (trend indicator)
    params:
      window: { type: int, required: true }
  forecast_accuracy:
    description: Absolute difference between estimated and reported EPS (forecast error)
    params: {}

  # Income Statement Enrichments
  gross_margin:
    description: Gross Margin = Gross Profit / Total Revenue (profitability measure)
    params: {}
  operating_margin:
    description: Operating Margin = Operating Income / Total Revenue (operational efficiency)
    params: {}
  net_margin:
    description: Net Margin = Net Income / Total Revenue (bottom-line profitability)
    params: {}
  ebitda_margin:
    description: EBITDA Margin = EBITDA / Total Revenue (cash profitability)
    params: {}
  rd_intensity:
    description: R&D Intensity = Research & Development / Total Revenue (innovation investment)
    params: {}
  interest_coverage:
    description: Interest Coverage = EBIT / Interest Expense (debt service ability)
    params: {}

  #  Custom/Lambda Features
  # NOTE: 'custom_' is a PREFIX pattern, not a feature name itself.
  # Any feature with name starting with 'custom_' (e.g., 'custom_price_ratio', 'custom_my_indicator')
  # will be treated as a custom feature that executes user-provided Python code.
  # The code runs in a RESTRICTED environment with:
  #   - Safe builtins only (no file I/O, no imports, no eval, etc.)
  #   - Access to: numpy (as np), pandas (as pd), math, random modules
  #   - Input: group DataFrame as variable 'g'
  #   - Output: Must assign result to variable 'series' (a pd.Series)
  # Required params:
  #   - code: Python code string that assigns to 'series'
  #   - as: Output column name for the resulting feature
